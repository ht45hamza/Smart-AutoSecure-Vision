<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart AutoSecure Vision™</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .live-badge {
      background: #e74c3c;
      color: white;
      padding: 6px 14px;
      border-radius: 30px;
      font-size: 0.8rem;
      font-weight: bold;
    }

    .small-cam:hover {
      transform: scale(1.07);
      border-color: #3498db !important;
    }

    .log-item {
      padding: 10px;
      background: #1e2a3a;
      border-radius: 12px;
      margin-bottom: 8px;
      border-left: 4px solid #3498db;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .log-item.suspect {
      border-left-color: #e74c3c;
      background: rgba(231, 76, 60, 0.1);
    }

    .log-item .avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #334155;
    }

    .log-item .content {
      flex-grow: 1;
    }

    .log-item .time {
      font-size: 0.75rem;
      color: #64748b;
    }

    .in {
      color: #2ecc71;
      font-weight: bold;
    }

    .out {
      color: #e74c3c;
      font-weight: bold;
    }

    /* Emergency Overlay */
    #emergencyOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(220, 38, 38, 0.85);
      z-index: 9999;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      text-align: center;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% {
        opacity: 0.9;
      }

      50% {
        opacity: 1;
      }

      100% {
        opacity: 0.9;
      }
    }

    /* ROI Modal Styles */
    #roiContainer {
      position: relative;
      display: inline-block;
      width: 100%;
      background: #000;
      min-height: 300px;
    }

    #roiFeed {
      width: 100%;
      display: block;
    }

    #roiCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }

    .shape-btn {
      width: 40px;
      height: 40px;
      margin-right: 5px;
    }

    .shape-btn.active {
      border: 2px solid #3498db;
      background: #34495e;
    }
  </style>
</head>

<body>

  <div id="emergencyOverlay">
    <i class="fas fa-exclamation-triangle fa-5x mb-4"></i>
    <h1 class="display-1 fw-bold">SECURITY ALERT</h1>
    <h2 id="alertMessage">WEAPON DETECTED</h2>
    <div class="mt-4 p-3 bg-black bg-opacity-50 rounded" style="min-width: 400px;">
      <h4><i class="fas fa-phone-volume"></i> AUTOMATED CALL:</h4>
      <h3 class="fw-bold" id="callingText">...</h3>
    </div>
  </div>

  <!-- Top Bar -->
  <div class="topbar px-4 py-3 d-flex justify-content-between align-items-center">
    <h3 class="mb-0"><i class="fas fa-shield-alt text-primary"></i> Smart AutoSecure Vision™</h3>
    <div>
      <button class="btn btn-outline-info me-3" data-bs-toggle="modal" data-bs-target="#cameraModal">
        <i class="fas fa-video"></i> Add Camera
      </button>
      <button class="btn btn-warning" onclick="window.location.href='/admin'">
        <i class="fas fa-users-cog"></i> Settings
      </button>
    </div>
  </div>

  <div class="container-fluid">
    <div class="row">

      <!-- Left Sidebar -->
      <div class="col-md-3 sidebar p-4">
        <h5 class="text-center text-info mb-4">Today's Summary — <span id="todayDate"></span></h5>

        <div class="stat-card suspects mb-3">
          <h6>Today's Suspects</h6>
          <div class="count" id="suspects">0</div>
        </div>
        <div class="stat-card unknown mb-3">
          <h6>Today's Unknown</h6>
          <div class="count" id="unknown">0</div>
        </div>
        <div class="stat-card known mb-3">
          <h6>Today's Known</h6>
          <div class="count" id="known">0</div>
        </div>
        <div class="stat-card traffic">
          <h6>Today's Total Traffic</h6>
          <div class="count" id="traffic">0</div>
        </div>
      </div>

      <!-- Center: Live Video -->
      <div class="col-md-6 p-4 text-center">
        <h2 class="mb-4">Live Video with Suspect Detection</h2>

        <!-- Main Big Camera -->
        <div class="main-video position-relative mb-4">
          <img id="mainFeed" src="" class="w-100 h-100" style="object-fit: cover; border-radius: 18px;">
          <div class="live-badge position-absolute top-0 start-0 m-3">LIVE</div>
          <div class="no-cam position-absolute top-50 start-50 translate-middle text-white-50" id="noCamText">
            Click "Add Camera" to begin
          </div>
        </div>

        <!-- Small Grid -->
        <div class="small-grid" id="smallGrid"></div>

        <button class="btn btn-outline-light mt-4 btn-lg">
          <i class="fas fa-plus"></i> Select Other
        </button>
      </div>

      <!-- Right: Live Tracking -->
      <div class="col-md-3 log-panel p-4">
        <h5 class="text-info mb-4"><i class="fas fa-history"></i> Live Tracking</h5>
        <div id="trackingLog" style="max-height: 600px; overflow-y: auto; padding-right: 5px;">
          <p class="text-muted text-center mt-5">No activity yet</p>
        </div>
      </div>

    </div>
  </div>

  <!-- Camera Modal -->
  <div class="modal fade" id="cameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="fas fa-video"></i> Select Camera</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="cameraList">
          <p class="text-center"><i class="fas fa-spinner fa-spin"></i> Detecting cameras...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Person Modal -->
  <div class="modal fade" id="personModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-user-plus"></i> Add Known Person</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <form id="addPersonForm" action="/admin/add" method="POST" enctype="multipart/form-data">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" name="name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Relation (e.g., Family, Employee)</label>
              <input type="text" class="form-control" name="relation" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Phone Number</label>
              <input type="tel" class="form-control" name="phone" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Address</label>
              <textarea class="form-control" name="address" rows="3" required></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Upload Photo</label>
              <input type="file" class="form-control" name="photo" accept="image/*" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Save Person</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ROI Setup Modal -->
  <div class="modal fade" id="roiModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-0">
          <h5 class="modal-title"><i class="fas fa-crop-alt"></i> Setup Region of Interest (ROI)</h5>
        </div>
        <div class="modal-body p-0">
          <div class="p-2 border-bottom border-secondary d-flex justify-content-center">
            <button class="btn btn-dark shape-btn" id="btnRect" onclick="setTool('rect')" title="Rectangle"><i
                class="far fa-square"></i></button>
            <button class="btn btn-dark shape-btn" id="btnCircle" onclick="setTool('circle')" title="Circle"><i
                class="far fa-circle"></i></button>
            <button class="btn btn-dark shape-btn" id="btnPoly" onclick="setTool('poly')" title="Polygon"><i
                class="fas fa-draw-polygon"></i></button>
            <button class="btn btn-dark shape-btn" id="btnFree" onclick="setTool('freehand')" title="Freehand/Lasso"><i
                class="fas fa-pen"></i></button>
            <div class="vr mx-2 bg-secondary"></div>
            <button class="btn btn-outline-danger btn-sm" onclick="clearRoi()">Clear</button>
          </div>

          <div id="roiContainer">
            <img id="roiFeed" src="">
            <canvas id="roiCanvas"></canvas>
            <div
              class="position-absolute bottom-0 start-0 w-100 p-2 text-center bg-black bg-opacity-50 pointer-events-none">
              <span id="roiHelp" class="small text-info">Select a tool to draw ROI</span>
            </div>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-secondary" onclick="skipRoi()">Skip / Full Screen</button>
          <button type="button" class="btn btn-primary" onclick="saveRoi()">Save ROI</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer text-center py-3">
    Copyright © HalalSoft Solutions 2025 — Smart AutoSecure Vision™ | Privacy-First AI Surveillance
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Set today's date
    document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-GB');

    let mainCameraId = null;

    // Load cameras when modal opens
    document.getElementById('cameraModal').addEventListener('show.bs.modal', async () => {
      const list = document.getElementById('cameraList');
      list.innerHTML = '<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Detecting cameras (Server-side)...</p>';

      try {
        const res = await fetch('/cameras');
        const cams = await res.json();

        if (cams.length === 0) {
          list.innerHTML = '<p class="text-danger text-center">No camera found on server!</p>';
          return;
        }

        let html = '';
        cams.forEach((cam) => {
          const isAdded = addedCameras.has(cam.id);
          // Ensure ID is treated as number for calls
          html += `
            <div class="p-3 rounded mb-2 text-start ${isAdded ? 'bg-secondary' : 'bg-primary'}"
                 style="cursor:${isAdded ? 'not-allowed' : 'pointer'}; opacity:${isAdded ? '0.6' : '1'}"
                 ${!isAdded ? `onclick="addCamera(${cam.id}, '${cam.label}')"` : ''}>
              <strong>${cam.label}${isAdded ? ' (Already Added)' : ''}</strong><br>
              <small>Device ID: ${cam.id}</small>
            </div>`;
        });
        list.innerHTML = html;
      } catch (err) {
        list.innerHTML = '<p class="text-danger">Error fetching cameras from server.</p>';
      }
    });

    // Add camera
    async function addCamera(id, label) {
      const res = await fetch('/add_camera', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, label })
      });
      const data = await res.json();

      if (!data.success) {
        alert(data.message);
        return;
      }

      if (data.main !== undefined) {
        mainCameraId = data.main;
        document.getElementById('mainFeed').src = `/video_feed/${mainCameraId}?t=${Date.now()}`;
        document.getElementById('noCamText').style.display = 'none';
      }

      addedCameras.add(id); // Update local state

      // Add to small grid
      if (data.id && data.id !== data.main) {
        const wrapper = document.createElement('div');
        wrapper.className = 'small-cam position-relative';
        wrapper.innerHTML = `
          <img src="/video_feed/${data.id}?t=${Date.now()}" class="w-100 h-100" style="object-fit: cover; border-radius: 14px;" onclick="setMainCamera(${data.id})">
          <div class="live-badge position-absolute top-0 start-0 m-2" style="font-size:0.7rem;padding:4px 10px;">LIVE</div>
          <button class="btn btn-sm btn-dark position-absolute top-0 end-0 m-2" style="opacity:0.8;" onclick="event.stopPropagation(); setupRoi(${data.id})" title="Edit ROI">
                <i class="fas fa-crop-alt"></i>
          </button>
        `;
        document.getElementById('smallGrid').appendChild(wrapper);
      }

      // Add "Edit ROI" button to MAIN camera too
      let mainEditBtn = document.getElementById('mainRoiBtn');
      if (mainCameraId) {
        if (!mainEditBtn) {
          const btn = document.createElement('button');
          btn.id = 'mainRoiBtn';
          btn.className = 'btn btn-sm btn-dark position-absolute top-0 end-0 m-4';
          btn.innerHTML = '<i class="fas fa-crop-alt"></i> Edit ROI';
          btn.onclick = () => setupRoi(mainCameraId);
          document.querySelector('.main-video').appendChild(btn);
        } else {
          btn.onclick = () => setupRoi(mainCameraId);
        }
      }

      bootstrap.Modal.getInstance(document.getElementById('cameraModal')).hide();

      // Open ROI Setup
      setupRoi(data.id);
    }

    // ROI Logic
    let currentRoiCamId = null;
    let currentTool = 'rect';
    let isDrawing = false;
    let roiPoints = []; // [[x,y], ...] or [x,y,w,h] etc
    let roiShape = null; // {type, points} to save

    const canvas = document.getElementById('roiCanvas');
    const ctx = canvas.getContext('2d');
    const img = document.getElementById('roiFeed');

    function setupRoi(id) {
      currentRoiCamId = id;
      const modal = new bootstrap.Modal(document.getElementById('roiModal'));
      img.src = `/video_feed/${id}?t=${Date.now()}`;

      // Wait for image to load to set canvas size
      img.onload = () => {
        canvas.width = img.clientWidth;
        canvas.height = img.clientHeight;
        clearRoi();
      }

      // Resize observer
      new ResizeObserver(() => {
        canvas.width = img.clientWidth;
        canvas.height = img.clientHeight;
      }).observe(img);

      modal.show();
    }

    function setTool(tool) {
      currentTool = tool;
      document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
      // Map button IDs
      const map = { 'rect': 'btnRect', 'circle': 'btnCircle', 'poly': 'btnPoly', 'freehand': 'btnFree' };
      document.getElementById(map[tool]).classList.add('active');

      let help = "";
      if (tool === 'rect') help = "Click and drag to draw rectangle";
      if (tool === 'circle') help = "Click center and drag to define radius";
      if (tool === 'poly') help = "Click to add points. Double-click to finish.";
      if (tool === 'freehand') help = "Click and drag to draw freehand shape";
      document.getElementById('roiHelp').innerText = help;

      // Reset if switching tools mid-drawing? No, keep existing.
    }

    function clearRoi() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      roiPoints = [];
      roiShape = null;
      isDrawing = false;
    }

    // Canvas Events
    canvas.addEventListener('mousedown', e => {
      const rect = canvas.getBoundingClientRect();
      // Clamp
      let x = Math.max(0, Math.min(canvas.width, e.clientX - rect.left));
      let y = Math.max(0, Math.min(canvas.height, e.clientY - rect.top));

      if (currentTool === 'poly') {
        // Snap to close
        if (roiPoints.length > 2) {
          const sx = roiPoints[0][0];
          const sy = roiPoints[0][1];
          const dist = Math.sqrt((x - sx) ** 2 + (y - sy) ** 2);
          if (dist < 25) { // Increased snap radius (25px)
            finalizeShape();
            isDrawing = false;
            return;
          }
        }
        roiPoints.push([x, y]);
        draw(x, y);
        return;
      }

      isDrawing = true;
      if (currentTool === 'rect') {
        roiPoints = [x, y, 0, 0]; // x, y, w, h
      } else if (currentTool === 'circle') {
        roiPoints = [x, y, 0]; // cx, cy, r
      } else if (currentTool === 'freehand') {
        roiPoints = [[x, y]];
      }
    });

    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      let x = Math.max(0, Math.min(canvas.width, e.clientX - rect.left));
      let y = Math.max(0, Math.min(canvas.height, e.clientY - rect.top));

      if (currentTool === 'poly') {
        // Visualize line to cursor
        draw(x, y);
        return;
      }

      if (!isDrawing) return;

      if (currentTool === 'rect') {
        roiPoints[2] = x - roiPoints[0];
        roiPoints[3] = y - roiPoints[1];
      } else if (currentTool === 'circle') {
        const dx = x - roiPoints[0];
        const dy = y - roiPoints[1];
        roiPoints[2] = Math.sqrt(dx * dx + dy * dy);
      } else if (currentTool === 'freehand') {
        roiPoints.push([x, y]);

        // Auto-close loop if strictly drawing and returned to start
        if (roiPoints.length > 20) {
          const sx = roiPoints[0][0];
          const sy = roiPoints[0][1];
          const dist = Math.sqrt((x - sx) ** 2 + (y - sy) ** 2);
          if (dist < 20) {
            isDrawing = false;
            finalizeShape();
            return;
          }
        }
      }
      draw();
    });

    canvas.addEventListener('mouseup', e => {
      if (currentTool === 'poly') return; // Handled by dblclick
      if (!isDrawing) return;
      isDrawing = false;
      finalizeShape();
    });

    canvas.addEventListener('dblclick', e => {
      if (currentTool === 'poly') {
        finalizeShape();
        isDrawing = false;
      }
    });

    function draw(cursorX = null, cursorY = null) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#2ecc71';
      ctx.lineWidth = 3;
      ctx.fillStyle = 'rgba(46, 204, 113, 0.2)';

      ctx.beginPath();

      if (currentTool === 'rect' && roiPoints.length > 0) {
        // Normalize negatives
        const rx = roiPoints[2] < 0 ? roiPoints[0] + roiPoints[2] : roiPoints[0];
        const ry = roiPoints[3] < 0 ? roiPoints[1] + roiPoints[3] : roiPoints[1];
        const rw = Math.abs(roiPoints[2]);
        const rh = Math.abs(roiPoints[3]);
        ctx.rect(rx, ry, rw, rh);
        ctx.fill();
        ctx.stroke();
      }
      else if (currentTool === 'circle' && roiPoints.length > 0) {
        ctx.arc(roiPoints[0], roiPoints[1], roiPoints[2], 0, 2 * Math.PI);
        ctx.fill();
        ctx.stroke();
      }
      else if ((currentTool === 'poly' || currentTool === 'freehand') && roiPoints.length > 0) {
        ctx.moveTo(roiPoints[0][0], roiPoints[0][1]);
        for (let i = 1; i < roiPoints.length; i++) {
          ctx.lineTo(roiPoints[i][0], roiPoints[i][1]);
        }
        if (cursorX !== null && currentTool === 'poly') {
          // Visual Hint: Check if near start
          if (roiPoints.length > 2) {
            const sx = roiPoints[0][0];
            const sy = roiPoints[0][1];
            const dist = Math.sqrt((cursorX - sx) ** 2 + (cursorY - sy) ** 2);
            if (dist < 25) {
              // Snap visual
              ctx.lineTo(sx, sy);
              ctx.fillStyle = 'rgba(46, 204, 113, 0.5)'; // Fill hint
              ctx.fill();
            } else {
              ctx.lineTo(cursorX, cursorY);
            }
          } else {
            ctx.lineTo(cursorX, cursorY);
          }
        }
        if (!isDrawing && currentTool !== 'poly') ctx.closePath(); // Close if finished
        if (currentTool === 'poly' && roiPoints.length > 2 && cursorX === null) ctx.closePath();

        ctx.stroke();
        if (!isDrawing) ctx.fill();
      }
    }

    function finalizeShape() {
      // Validation
      roiShape = { type: currentTool, points: roiPoints };
      draw();
    }

    async function saveRoi() {
      if (!roiShape || roiPoints.length === 0) {
        alert("Please draw an area first or click Skip.");
        return;
      }

      // Normalize coordinates
      const w = canvas.width;
      const h = canvas.height;
      let normPoints = [];

      if (roiShape.type === 'rect') {
        // Normalize rect to always have positive width/height, x/y at top-left
        let x = roiShape.points[0];
        let y = roiShape.points[1];
        let rw = roiShape.points[2];
        let rh = roiShape.points[3];

        if (rw < 0) { x += rw; rw = Math.abs(rw); }
        if (rh < 0) { y += rh; rh = Math.abs(rh); }

        normPoints = [x / w, y / h, rw / w, rh / h];
      } else if (roiShape.type === 'circle') {
        // cx, cy, radius
        // Ensure radius is positive
        normPoints = [roiShape.points[0] / w, roiShape.points[1] / h, Math.abs(roiShape.points[2]) / w];
      } else {
        // Poly/Freehand: [[x,y], [x,y]...]
        normPoints = roiShape.points.map(p => [p[0] / w, p[1] / h]);
      }

      if (roiShape.type === 'poly' && normPoints.length < 3) {
        alert("Polygon must have at least 3 points.");
        return;
      }

      const payload = {
        id: currentRoiCamId,
        roi: { type: roiShape.type, points: normPoints }
      };

      await fetch('/api/set_roi', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      // Close
      const el = document.getElementById('roiModal');
      const modal = bootstrap.Modal.getInstance(el);
      modal.hide();

      // Refresh feeds
      if (currentRoiCamId === mainCameraId) {
        document.getElementById('mainFeed').src = `/video_feed/${currentRoiCamId}?t=${Date.now()}`;
      }
    }

    function skipRoi() {
      // Just hide
      const el = document.getElementById('roiModal');
      const modal = bootstrap.Modal.getInstance(el);
      if (modal) {
        modal.hide();
      } else {
        // Fallback
        new bootstrap.Modal(el).hide();
      }
    }

    // Set main camera
    async function setMainCamera(id) {
      await fetch(`/set_main/${id}`);
      document.getElementById('mainFeed').src = `/video_feed/${id}?t=${Date.now()}`;
    }

    const addedCameras = new Set();

    // Auto-load cameras on modal open AND on page load
    // Persistence Logic
    window.addEventListener('load', async () => {
      try {
        const res = await fetch('/api/added_cameras');
        const cameras = await res.json();

        cameras.forEach(cam => {
          addedCameras.add(cam.id);

          // Restore View
          if (cam.main) {
            mainCameraId = cam.id;
            document.getElementById('mainFeed').src = `/video_feed/${cam.id}?t=${Date.now()}`;
            document.getElementById('noCamText').style.display = 'none';

            // Restore Main ROI Button
            let mainEditBtn = document.getElementById('mainRoiBtn');
            if (!mainEditBtn) {
              const btn = document.createElement('button');
              btn.id = 'mainRoiBtn';
              btn.className = 'btn btn-sm btn-dark position-absolute top-0 end-0 m-4';
              btn.innerHTML = '<i class="fas fa-crop-alt"></i> Edit ROI';
              btn.onclick = () => setupRoi(cam.id);
              document.querySelector('.main-video').appendChild(btn);
            }
          } else {
            // Add to small grid
            const wrapper = document.createElement('div');
            wrapper.className = 'small-cam position-relative';
            wrapper.innerHTML = `
                      <img src="/video_feed/${cam.id}?t=${Date.now()}" class="w-100 h-100" style="object-fit: cover; border-radius: 14px;" onclick="setMainCamera(${cam.id})">
                      <div class="live-badge position-absolute top-0 start-0 m-2" style="font-size:0.7rem;padding:4px 10px;">LIVE</div>
                      <button class="btn btn-sm btn-dark position-absolute top-0 end-0 m-2" style="opacity:0.8;" onclick="event.stopPropagation(); setupRoi(${cam.id})" title="Edit ROI">
                            <i class="fas fa-crop-alt"></i>
                      </button>
                   `;
            document.getElementById('smallGrid').appendChild(wrapper);
          }
        });
      } catch (e) { console.error("Error restoring cameras", e); }
    });

    // document.getElementById('cameraModal').addEventListener('show.bs.modal', loadCameras); // Removed undefined function ref


    // Poll for stats
    setInterval(async () => {
      try {
        const res = await fetch('/api/stats');
        const data = await res.json();

        document.getElementById('suspects').innerText = data.suspects;
        document.getElementById('unknown').innerText = data.unknown;
        document.getElementById('known').innerText = data.known;
        document.getElementById('traffic').innerText = data.traffic;

        // Update Tracking Log
        const logContainer = document.getElementById('trackingLog');
        if (data.history.length > 0) {
          logContainer.innerHTML = data.history.slice().reverse().map(item => {
            let iconHtml = '';
            // Check for System/Weapon/System events
            if (item.name === 'System' || item.action.includes('Weapon') || item.action.includes('Violence')) {
              iconHtml = `<div class="rounded-circle d-flex align-items-center justify-content-center bg-danger text-white" style="width:45px; height:45px; min-width:45px; font-size:1.2rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                             </div>`;
            } else {
              // Ensure path is correct relative to /static if not already
              let imgPath = item.image;
              if (imgPath && !imgPath.startsWith('http')) {
                // If it doesn't start with /static/ and not /uploads/ (legacy), clean it up
                if (!imgPath.startsWith('/static/') && !imgPath.startsWith('static/')) {
                  imgPath = '/static/' + imgPath;
                } else if (imgPath.startsWith('static/')) {
                  imgPath = '/' + imgPath;
                }
              } else if (!imgPath) {
                imgPath = 'https://via.placeholder.com/45';
              }

              iconHtml = `<img src="${imgPath}" class="rounded-circle" style="width:45px; height:45px; object-fit:cover; border:2px solid ${item.name === 'Unknown' ? '#dc3545' : '#198754'};">`;
            }

            return `
            <div class="d-flex align-items-center mb-3 p-2 rounded bg-dark bg-opacity-50 border border-secondary">
              ${iconHtml}
              <div class="ms-3 overflow-hidden">
                <div class="d-flex justify-content-between align-items-center">
                  <strong class="${item.name === 'Unknown' ? 'text-danger' : (item.name === 'System' ? 'text-warning' : 'text-success')} text-truncate" style="max-width:140px;">${item.name}</strong>
                  <span class="small text-muted ms-2" style="font-size:0.75rem;">${item.date ? item.date + ' ' : ''}${item.time}</span>
                </div>
                <div class="small text-white-50 text-truncate">${item.action} <span class="text-secondary">• ${item.relation}</span></div>
              </div>
            </div>
            `;
          }).join('');
        }
      } catch (e) {
        console.error("Stats poll error", e);
      }
    }, 2000);

    // Poll for Emergency Status
    setInterval(async () => {
      try {
        const res = await fetch('/api/emergency_status');
        const data = await res.json();
        const overlay = document.getElementById('emergencyOverlay');

        if (data.active) {
          overlay.style.display = 'flex';
          document.getElementById('alertMessage').innerText = data.threat + " DETECTED";
          document.getElementById('callingText').innerText = data.calling + " (" + data.phone + ")";
        } else {
          overlay.style.display = 'none';
        }
      } catch (e) { }
    }, 1000);
  </script>

</body>

</html>